<script language="javascript" type="text/javascript">function init(){var wanInf;var aliasName=$.act(ACT_GET,L3_FORWARDING,null,null,["__ifAliasName"]);if(HTTP_CFG){var httpCfg=$.act(ACT_GET,HTTP_CFG,null,null,["httpRemotePort"])}if(INCLUDE_WAN_MODE){var sysMode=$.act(ACT_GET,SYS_MODE,null,null,["mode"])}if(INCLUDE_USB_3G_DONGLE){var wan3glnkcfgList=$.act(ACT_GL,WAN_USB_3G_LINK_CFG,null,null,["enable","backupEnable"])}if(INCLUDE_IPV6){var wanIPList=$.act(ACT_GL,WAN_IP_CONN,null,null,["enable","name","NATEnabled","connectionType","X_TP_IPv4Enabled"]);var wanPPPList=$.act(ACT_GL,WAN_PPP_CONN,null,null,["enable","name","NATEnabled","X_TP_IPv4Enabled","transportType"]);if(INCLUDE_L2TP){var wanL2TPList=$.act(ACT_GL,WAN_L2TP_CONN,null,null,["enable","name","NATEnabled"])}if(INCLUDE_PPTP){var wanPPTPList=$.act(ACT_GL,WAN_PPTP_CONN,null,null,["enable","name","NATEnabled"])}}else{var wanIPList=$.act(ACT_GL,WAN_IP_CONN,null,null,["enable","name","NATEnabled","connectionType"]);var wanPPPList=$.act(ACT_GL,WAN_PPP_CONN,null,null,["enable","name","NATEnabled","transportType"]);if(INCLUDE_L2TP){var wanL2TPList=$.act(ACT_GL,WAN_L2TP_CONN,null,null,["enable","name","NATEnabled"])}if(INCLUDE_PPTP){var wanPPTPList=$.act(ACT_GL,WAN_PPTP_CONN,null,null,["enable","name","NATEnabled"])}}var sel=$.id("wanInf");if(!$.exe()){if(HTTP_CFG){httpRemotePort=httpCfg.httpRemotePort}if(opt==1){pStk=stk[0]+","+stk[1]+","+stk[2]+",0,0,0";if(type=="ip"){vtlServCfg=$.act(ACT_GET,WAN_IP_CONN_PORTMAPPING,stk,null,["portMappingEnabled","externalPort","X_TP_ExternalPortEnd","portMappingProtocol","internalPort","X_TP_InternalPortEnd","internalClient"]);wanInf=$.act(ACT_GET,WAN_IP_CONN,pStk,null,["name"])}else{if(type=="ppp"){vtlServCfg=$.act(ACT_GET,WAN_PPP_CONN_PORTMAPPING,stk,null,["portMappingEnabled","externalPort","X_TP_ExternalPortEnd","portMappingProtocol","internalPort","X_TP_InternalPortEnd","internalClient"]);wanInf=$.act(ACT_GET,WAN_PPP_CONN,pStk,null,["name"])}else{if(type=="l2tp"){pStk=stk[0]+","+stk[1]+",0,0,0,0";vtlServCfg=$.act(ACT_GET,WAN_L2TP_CONN_PORTMAPPING,stk,null,["portMappingEnabled","externalPort","externalPortEnd","portMappingProtocol","internalPort","internalPortEnd","internalClient"]);wanInf=$.act(ACT_GET,WAN_L2TP_CONN,pStk,null,["name"])}else{if(type=="pptp"){pStk=stk[0]+","+stk[1]+",0,0,0,0";vtlServCfg=$.act(ACT_GET,WAN_PPTP_CONN_PORTMAPPING,stk,null,["portMappingEnabled","externalPort","externalPortEnd","portMappingProtocol","internalPort","internalPortEnd","internalClient"]);wanInf=$.act(ACT_GET,WAN_PPTP_CONN,pStk,null,["name"])}}}}if(!$.exe()){wanInfName=wanInf.name;if(type=="l2tp"||type=="pptp"){if(vtlServCfg.externalPort==vtlServCfg.externalPortEnd){$.id("applyPort").value=vtlServCfg.externalPort}else{$.id("applyPort").value=vtlServCfg.externalPort+"-"+vtlServCfg.externalPortEnd}$.id("ipAddr").value=vtlServCfg.internalClient;if(vtlServCfg.internalPort==vtlServCfg.externalPort&&vtlServCfg.internalPortEnd==vtlServCfg.externalPortEnd){$.id("interPort").value=""}else{if(vtlServCfg.internalPort==vtlServCfg.internalPortEnd){$.id("interPort").value=vtlServCfg.internalPort}else{$.id("interPort").value=vtlServCfg.internalPort+"-"+vtlServCfg.internalPortEnd}}}else{if(vtlServCfg.externalPort==vtlServCfg.X_TP_ExternalPortEnd){$.id("applyPort").value=vtlServCfg.externalPort}else{$.id("applyPort").value=vtlServCfg.externalPort+"-"+vtlServCfg.X_TP_ExternalPortEnd}$.id("ipAddr").value=vtlServCfg.internalClient;if(vtlServCfg.internalPort==vtlServCfg.externalPort&&vtlServCfg.X_TP_InternalPortEnd==vtlServCfg.X_TP_ExternalPortEnd){$.id("interPort").value=""}else{if(vtlServCfg.internalPort==vtlServCfg.X_TP_InternalPortEnd){$.id("interPort").value=vtlServCfg.internalPort}else{$.id("interPort").value=vtlServCfg.internalPort+"-"+vtlServCfg.X_TP_InternalPortEnd}}}$.id("TCP").selected=(vtlServCfg.portMappingProtocol=="TCP")?1:0;$.id("UDP").selected=(vtlServCfg.portMappingProtocol=="UDP")?1:0;$.id("ALL").selected=(vtlServCfg.portMappingProtocol=="TCP or UDP")?1:0;$.id("vtlServ_en").selected=(vtlServCfg.portMappingEnabled==1)?1:0;$.id("vtlServ_dis").selected=(vtlServCfg.portMappingEnabled==1)?0:1}}else{wanInfName=aliasName.__ifAliasName}var mode;if(INCLUDE_WAN_MODE){mode=sysMode.mode}var usb3gBackup=0;if(INCLUDE_USB_3G_DONGLE){$.each(wan3glnkcfgList,function(){if(this.enable==1){usb3gBackup=this.backupEnable;return false}})}var index=0;var flag=0;for(var i=0;i<wanIPList.length;i++){if((wanIPList[i].NATEnabled==1)&&(wanIPList[i].connectionType=="IP_Routed")&&(wanIPList[i].enable==1)&&(!INCLUDE_IPV6||wanIPList[i].X_TP_IPv4Enabled==1)){var option=$.c("option");option.value="ip:"+wanIPList[i].__stack;option.text=wanIPList[i].name;try{sel.add(option,null)}catch(e){sel.add(option)}index++;if(wanIPList[i].name==wanInfName){sel.selectedIndex=index-1}flag=1}}for(var j=0;j<wanPPPList.length;j++){if((wanPPPList[j].NATEnabled==1)&&((wanPPPList[j].enable==1)||(wanPPPList[j].transportType=="PPP3G"&&(mode=="USB_3G"||usb3gBackup==1)))&&(!INCLUDE_IPV6||wanPPPList[j].X_TP_IPv4Enabled==1)){var option=$.c("option");option.value="ppp:"+wanPPPList[j].__stack;option.text=wanPPPList[j].name;try{sel.add(option,null)}catch(e){sel.add(option)}index++;if(wanPPPList[j].name==wanInfName){sel.selectedIndex=index-1}flag=1}}if(INCLUDE_L2TP){for(var j=0;j<wanL2TPList.length;j++){if(wanL2TPList[j].enable==1){var option=$.c("option");option.value="l2tp:"+wanL2TPList[j].__stack;option.text=wanL2TPList[j].name;try{sel.add(option,null)}catch(e){sel.add(option)}index++;if(wanL2TPList[j].name==wanInfName){sel.selectedIndex=index-1}flag=1}}}if(INCLUDE_PPTP){for(var j=0;j<wanPPTPList.length;j++){if(wanPPTPList[j].enable==1){var option=$.c("option");option.value="pptp:"+wanPPTPList[j].__stack;option.text=wanPPTPList[j].name;try{sel.add(option,null)}catch(e){sel.add(option)}index++;if(wanPPTPList[j].name==wanInfName){sel.selectedIndex=index-1}flag=1}}}if(flag==0){var option=$.c("option");option.value="";option.text="No available interface.";try{sel.add(option,null)}catch(e){sel.add(option)}$.id("saveBtn").disabled=1}}}function isPort(val,type){var c;var ch;if(type=="applyPort"){ch="0123456789-"}else{if(type=="interPort"){if(val==""){return true}ch="0123456789"}}for(var i=0;i<val.length;i++){c=val.charAt(i);if(ch.indexOf(c)==-1){return false}}if((val.split("-").length!=1)&&(val.split("-").length!=2)){return false}if((val.split("-").length==2)&&(val.split("-")[0]=="")){return false}if((val.split("-").length==2)&&(val.split("-")[1]=="")){return false}return true}function checkConflictFtpDataPort(exPort,exPortEnd){var conflict=false;if(exPortEnd==0){if((59990<=exPort)&&(exPort<=59999)){conflict=true}}else{if(exPort==0){if((59990<=exPortEnd)&&(exPortEnd<=59999)){conflict=true}}else{if(!((59999<exPort)||(exPortEnd<59990))){conflict=true}}}if(conflict){$.alert(ERR_FTP_DATA_PORT_CONFLICT);return false}return true}function checkConflictFtpPort(exPort,exPortEnd){var ftpServer=$.act(ACT_GET,FTP_SERVER,null,null,null);var conflict=false;if($.exe()){return}if((ftpServer.enable==1)&&(ftpServer.accessFromInternet==1)){if(exPort==0){if(ftpServer.portNumber==exPortEnd){conflict=true}}else{if(exPortEnd==0){if(ftpServer.portNumber==exPort){conflict=true}}else{if((exPort<=ftpServer.portNumber)&&(ftpServer.portNumber<=exPortEnd)){conflict=true}}}}if(conflict){if(confirm(c_str.forwarding_ftp_conflict)){$.act(ACT_SET,FTP_SERVER,null,null,["accessFromInternet=0"]);$.exe();return true}else{return false}}return true}function check_port(port_string){var sub_port_array;sub_port_array=port_string.split("-");if(sub_port_array.length==2){if(sub_port_array[0]<=httpRemotePort&&sub_port_array[1]>=httpRemotePort){$.alert(CMM_VS_CONFLICT_REMOTE_WEB_PORT);return false}}else{if(port_string==httpRemotePort){$.alert(CMM_VS_CONFLICT_REMOTE_WEB_PORT);return false}}return true}function doSave(){var tmpWanInfType=($.id("wanInf").value).split(":")[0];var tmpWanInfStk=($.id("wanInf").value).split(":")[1];if($.ifip($.id("ipAddr").value,true)){$.alert(ERR_IP_FORMAT);var element=$.id("ipAddr");if(element){element.focus();element.select()}return false}var vsAttrs={};vsAttrs.internalClient=$.ip2ip($.id("ipAddr").value);vsAttrs.portMappingProtocol=$.id("protol").value;vsAttrs.portMappingEnabled=($.id("vtlServ_en").selected==1)?1:0;if(($.id("applyPort").value=="")||(!isPort($.id("applyPort").value,"applyPort"))){$.alert(ERR_VS_PORT_INVAD);var element=$.id("applyPort");if(element){element.focus();element.select()}return false}if(HTTP_CFG){if(!check_port($.id("applyPort").value)){var element=$.id("applyPort");if(element){element.focus();element.select()}return false}}var tmpApplyPort=$.id("applyPort").value;if(tmpWanInfType=="l2tp"||tmpWanInfType=="pptp"){if(tmpApplyPort.split("-").length==1){vsAttrs.externalPort=parseInt(tmpApplyPort,10);vsAttrs.externalPortEnd=parseInt(tmpApplyPort,10)}else{if(tmpApplyPort.split("-")[0]>tmpApplyPort.split("-")[1]){vsAttrs.externalPort=parseInt(tmpApplyPort.split("-")[1],10);vsAttrs.externalPortEnd=parseInt(tmpApplyPort.split("-")[0],10)}else{vsAttrs.externalPort=parseInt(tmpApplyPort.split("-")[0],10);vsAttrs.externalPortEnd=parseInt(tmpApplyPort.split("-")[1],10)}}if(INCLUDE_USB_FTP_SERVER){if(!checkConflictFtpDataPort(vsAttrs.externalPort,vsAttrs.externalPortEnd)){var element=$.id("applyPort");if(element){element.focus();element.select()}return false}if(vsAttrs.portMappingEnabled&&!checkConflictFtpPort(vsAttrs.externalPort,vsAttrs.externalPortEnd)){var element=$.id("applyPort");if(element){element.focus();element.select()}return false}}}else{if(tmpApplyPort.split("-").length==1){vsAttrs.externalPort=parseInt(tmpApplyPort,10);vsAttrs.X_TP_ExternalPortEnd=parseInt(tmpApplyPort,10)}else{if(tmpApplyPort.split("-")[0]>tmpApplyPort.split("-")[1]){vsAttrs.externalPort=parseInt(tmpApplyPort.split("-")[1],10);vsAttrs.X_TP_ExternalPortEnd=parseInt(tmpApplyPort.split("-")[0],10)}else{vsAttrs.externalPort=parseInt(tmpApplyPort.split("-")[0],10);vsAttrs.X_TP_ExternalPortEnd=parseInt(tmpApplyPort.split("-")[1],10)}}if(INCLUDE_USB_FTP_SERVER){if(!checkConflictFtpDataPort(vsAttrs.externalPort,vsAttrs.X_TP_ExternalPortEnd)){var element=$.id("applyPort");if(element){element.focus();element.select()}return false}if(vsAttrs.portMappingEnabled&&!checkConflictFtpPort(vsAttrs.externalPort,vsAttrs.X_TP_ExternalPortEnd)){var element=$.id("applyPort");if(element){element.focus();element.select()}return false}}}if((!isPort($.id("interPort").value,"interPort"))){$.alert(ERR_VS_INTER_PORT_INVAD);var element=$.id("interPort");if(element){element.focus();element.select()}return false}if(tmpWanInfType=="l2tp"||tmpWanInfType=="pptp"){if($.id("interPort").value!=""){vsAttrs.internalPort=vsAttrs.internalPortEnd=$.id("interPort").value}else{vsAttrs.internalPort=vsAttrs.externalPort;vsAttrs.internalPortEnd=vsAttrs.externalPortEnd}}else{if($.id("interPort").value!=""){vsAttrs.internalPort=vsAttrs.X_TP_InternalPortEnd=$.id("interPort").value}else{vsAttrs.internalPort=vsAttrs.externalPort;vsAttrs.X_TP_InternalPortEnd=vsAttrs.X_TP_ExternalPortEnd}}$.addLoading($.id("saveBtn"));if(opt==0){if(tmpWanInfType=="ip"){$.act(ACT_ADD,WAN_IP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="ppp"){$.act(ACT_ADD,WAN_PPP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="l2tp"){$.act(ACT_ADD,WAN_L2TP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="pptp"){$.act(ACT_ADD,WAN_PPTP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}}}}$.exe(function(ret){if(!ret){$.loadMain("virtualServer.htm")}})}else{if(opt==1){if(wanInfName==$.id("wanInf").options[$.id("wanInf").selectedIndex].text){if(type=="ip"){$.act(ACT_SET,WAN_IP_CONN_PORTMAPPING,stk,null,vsAttrs)}else{if(type=="ppp"){$.act(ACT_SET,WAN_PPP_CONN_PORTMAPPING,stk,null,vsAttrs)}else{if(type=="l2tp"){$.act(ACT_SET,WAN_L2TP_CONN_PORTMAPPING,stk,null,vsAttrs)}else{if(type=="pptp"){$.act(ACT_SET,WAN_PPTP_CONN_PORTMAPPING,stk,null,vsAttrs)}}}}$.exe(function(ret){if(!ret){$.loadMain("virtualServer.htm")}})}else{if(type=="ip"){$.act(ACT_DEL,WAN_IP_CONN_PORTMAPPING,stk,null)}else{if(type=="ppp"){$.act(ACT_DEL,WAN_PPP_CONN_PORTMAPPING,stk,null)}else{if(type=="l2tp"){$.act(ACT_DEL,WAN_L2TP_CONN_PORTMAPPING,stk,null)}else{if(type=="pptp"){$.act(ACT_DEL,WAN_PPTP_CONN_PORTMAPPING,stk,null)}}}}$.exe(function(ret){if(!ret){if(tmpWanInfType=="ip"){$.act(ACT_ADD,WAN_IP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="ppp"){$.act(ACT_ADD,WAN_PPP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="l2tp"){$.act(ACT_ADD,WAN_L2TP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}else{if(tmpWanInfType=="pptp"){$.act(ACT_ADD,WAN_PPTP_CONN_PORTMAPPING,null,tmpWanInfStk,vsAttrs)}}}}$.exe(function(ret){if(!ret){$.loadMain("virtualServer.htm")}else{vsAttrs.portMappingEnabled=vtlServCfg.portMappingEnabled;vsAttrs.externalPort=vtlServCfg.externalPort;vsAttrs.internalPort=vtlServCfg.internalPort;vsAttrs.internalClient=vtlServCfg.internalClient;if(tmpWanInfType=="l2tp"||tmpWanInfType=="pptp"){vsAttrs.externalPortEnd=vtlServCfg.externalPortEnd;vsAttrs.internalPortEnd=vtlServCfg.internalPortEnd}else{vsAttrs.X_TP_ExternalPortEnd=vtlServCfg.X_TP_ExternalPortEnd;vsAttrs.X_TP_InternalPortEnd=vtlServCfg.X_TP_InternalPortEnd}if(type=="ip"){$.act(ACT_ADD,WAN_IP_CONN_PORTMAPPING,null,pStk,vsAttrs)}else{if(type=="ppp"){$.act(ACT_ADD,WAN_PPP_CONN_PORTMAPPING,null,pStk,vsAttrs)}else{if(type=="l2tp"){$.act(ACT_ADD,WAN_L2TP_CONN_PORTMAPPING,null,pStk,vsAttrs)}else{if(type=="pptp"){$.act(ACT_ADD,WAN_PPTP_CONN_PORTMAPPING,null,pStk,vsAttrs)}}}}$.exe()}})}})}}}}function changeApplyPort(){var applyPort=$.id("commApply").value;$.id("vtlServ_en").selected=1;if(applyPort=="DNS"){$.id("applyPort").value=53;$.id("interPort").value=53;$.id("ALL").selected=1;$.id("TCP").selected=0;$.id("UDP").selected=0}else{if(applyPort=="FTP"){$.id("applyPort").value=21;$.id("interPort").value=21;$.id("TCP").selected=1}else{if(applyPort=="GOPHER"){$.id("applyPort").value=70;$.id("interPort").value=70;$.id("TCP").selected=1}else{if(applyPort=="HTTP"){$.id("applyPort").value=80;$.id("interPort").value=80;$.id("TCP").selected=1}else{if(applyPort=="NNTP"){$.id("applyPort").value=119;$.id("interPort").value=119;$.id("TCP").selected=1}else{if(applyPort=="POP3"){$.id("applyPort").value=110;$.id("interPort").value=110;$.id("TCP").selected=1}else{if(applyPort=="PPTP"){$.id("applyPort").value=1723;$.id("interPort").value=1723;$.id("ALL").selected=1}else{if(applyPort=="SMTP"){$.id("applyPort").value=25;$.id("interPort").value=25;$.id("TCP").selected=1}else{if(applyPort=="SOCK"){$.id("applyPort").value=1080;$.id("interPort").value=1080;$.id("ALL").selected=1}else{if(applyPort=="TELNET"){$.id("applyPort").value=23;$.id("interPort").value=23;$.id("TCP").selected=1}else{$.id("applyPort").value="";$.id("interPort").value="";$.id("ALL").selected=1}}}}}}}}}}};</script>
<p class="et T" id="et">Virtual Server</p>
<div class="con1 L">
<p class="ct"></p>
<p class="bl"></p>
<div class="con2">
<p class="L2 nd"><b class="item M T T_intf">Interface:</b><select class="L" id="wanInf"></select></p>
<p class="br nd"></p>
<p class="L2"><b class="item M T" id="t_port">Service Port:</b><input type="text" class="text" id="applyPort" size="15"  maxlength="11" />(XX-XX or XX)</p>
<p class="L2"><b class="item M T T_ipaddr">IP Address:</b><input type="text" class="text" id="ipAddr" size="15"  maxlength="15" /></p>
<p class="L2"><b class="item M T" id="t_interPort">Internal Port:</b><input type="text" class="text" id="interPort" size="15"  maxlength="11" /><span class="T" id="t_note4">(XX or keep empty. If it's empty, Internal port equals to Service port)</span></p>
<p class="L2"><b class="item M T T_proto">Protocol:</b>
<select class="L" id="protol">
<option class="T T_all" id="ALL" value="TCP or UDP" selected>ALL</option>
<option id="TCP" value="TCP">TCP</option>
<option id="UDP" value="UDP">UDP</option>
</select></p>
<p class="L2"><b class="item M T T_status">Status:</b><select class="L" id="state">
<option id="vtlServ_en" value="1" class="T T_enabled">Enabled</option>
<option id="vtlServ_dis" value="0" class="T T_disabled">Disabled</option>
</select></p>
<p class="L2"><b class="item M T" id="t_cport">Common Service Port:</b><select class="L" id="commApply" onchange="changeApplyPort();">
<option class="T" id="t_sel" value="please">---Please Select---</option>
<option value="DNS">DNS</option>
<option value="FTP">FTP</option>
<option value="GOPHER">GOPHER</option>
<option value="HTTP">HTTP</option>
<option value="NNTP">NNTP</option>
<option value="POP3">POP3</option>
<option value="PPTP">PPTP</option>
<option value="SMTP">SMTP</option>
<option value="SOCK">SOCK</option>
<option value="TELNET">TELNET</option>
</select></p>
</div>
<p class="bl"></p>
<p class="tail" id="tail">
<input type="button" class="button L T T_save" id="saveBtn" value="Save" onclick="doSave();" />
<input type="button" class="button L T T_back" value="Back" onclick="$.loadMain('virtualServer.htm')"/>
</p>
</div>
<script language="javascript" type="text/javascript">$.loadHelp();var opt=$.mainParam[0];var type=$.mainParam[1];var stk=$.mainParam[2];var pStk;var wanInfName="";var vtlServCfg;var httpRemotePort;if(INCLUDE_CWMP){$.removeClass($.id("t_note2"),"nd")}else{$.removeClass($.id("t_note3"),"nd")}init();</script>